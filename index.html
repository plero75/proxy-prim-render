const CORS_PROXY = "https://ratp-proxy.hippodrome-proxy42.workers.dev/?url=";

const STOP_IDS = {
  rer_joinville: "STIF:StopPoint:Q:39406:",
  bus77_hippo: "STIF:StopPoint:Q:463640:",
  bus201_breuil: "STIF:StopPoint:Q:463646:"
};

const LINE_REFS = {
  rer_a: "STIF:Line::C01742:",
  bus77: "STIF:Line::C01789:",
  bus201: "STIF:Line::C01805:"
};

async function loadHorairesData() {
  try {
    const res = await fetch("static/horaires_export.json");
    if (!res.ok) throw new Error(`Erreur HTTP ${res.status} lors du chargement des horaires.`);
    const data = await res.json();
    return data;
  } catch (e) {
    console.error("Erreur chargement horaires_export.json:", e);
    return null;
  }
}

function displayHorairesFooter(data, lineId, elementId) {
  const line = data.lines.find(l => l.line_id === lineId);
  if (line) {
    document.querySelector(elementId).innerHTML = `⏱️ Premier : ${line.first_time} | Dernier : ${line.last_time}`;
  } else {
    document.querySelector(elementId).innerHTML = "⏱️ Horaires indisponibles.";
  }
}

async function fetchPrimStop(monitoringRef, lineRef, elementId) {
  const url = `${CORS_PROXY}https://prim.iledefrance-mobilites.fr/marketplace/stop-monitoring?MonitoringRef=${monitoringRef}&LineRef=${lineRef}`;
  const controller = new AbortController();
  const timeout = setTimeout(() => controller.abort(), 10000);
  try {
    const res = await fetch(url, { signal: controller.signal });
    if (!res.ok) throw new Error(`Erreur HTTP ${res.status} lors de la requête PRIM.`);
    const data = await res.json();
    const visits = data?.Siri?.ServiceDelivery?.StopMonitoringDelivery?.[0]?.MonitoredStopVisit || [];
    const trips = visits.filter(v => v.MonitoredVehicleJourney?.LineRef?.value === lineRef)
      .slice(0, 4)
      .map(v => ({
        aimed: v.MonitoredVehicleJourney.MonitoredCall.AimedDepartureTime,
        expected: v.MonitoredVehicleJourney.MonitoredCall.ExpectedDepartureTime,
        direction: v.MonitoredVehicleJourney.DirectionName?.[0]?.value || "Direction inconnue"
      }));
    document.querySelector(elementId).innerHTML = trips.length ? trips.map(formatTrip).join("<br>") : "Aucun passage disponible.";
  } catch (e) {
    document.querySelector(elementId).innerHTML = `Erreur : ${e.message}`;
  } finally {
    clearTimeout(timeout);
  }
}

function formatTrip(trip) {
  const aimed = aimedTime(trip.aimed), expected = aimedTime(trip.expected), now = new Date();
  const timeLeft = Math.round((expected - now) / 60000), delay = aimed && expected ? Math.round((expected - aimed) / 60000) : 0;
  const aimedStr = aimed ? aimed.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : "—", expectedStr = expected.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
  const delayStr = delay > 1 ? ` (retard +${delay} min)` : "", imminent = timeLeft <= 1.5 ? "🟢 imminent" : `⏳ dans ${timeLeft} min`;
  return `🕐 ${aimedStr} → ${expectedStr} ${imminent}${delayStr} | ${trip.direction}`;
}

const aimedTime = iso => iso ? new Date(iso) : null;

async function main() {
  try {
    const horairesData = await loadHorairesData();
    if (horairesData) {
      displayHorairesFooter(horairesData, LINE_REFS.rer_a, "#rer-a-horaires");
      displayHorairesFooter(horairesData, LINE_REFS.bus77, "#bus-77-horaires");
      displayHorairesFooter(horairesData, LINE_REFS.bus201, "#bus-201-horaires");
    }

    await Promise.allSettled([
      fetchPrimStop(STOP_IDS.rer_joinville, LINE_REFS.rer_a, "#rer-a"),
      fetchPrimStop(STOP_IDS.bus77_hippo, LINE_REFS.bus77, "#bus-77"),
      fetchPrimStop(STOP_IDS.bus201_breuil, LINE_REFS.bus201, "#bus-201")
    ]);

  } catch (e) {
    console.error("🚨 Erreur inattendue :", e);
  }
}

main();
