import{API_PROXY,STOPS,LINES,ICONS}from"./config.js";let stopsGtfs={};const REFRESH_MS=15e3,maxBackoff=12e4;let currentInterval=15e3;const navitiaSA=t=>`https://prim.iledefrance-mobilites.fr/marketplace/v2/navitia/coverage/fr-idf/stop_areas/${t}/departures?count=6&data_freshness=realtime`,navitiaTraffic=t=>`https://prim.iledefrance-mobilites.fr/marketplace/v2/navitia/coverage/fr-idf/lines/${t}/traffic`,storeKey=t=>`cache_${t}`;async function fetchJSON(t){const e=await fetch(`${API_PROXY}?url=${encodeURIComponent(t)}`);if(!e.ok)throw new Error(e.status);return e.json()}async function fetchStop(t){try{const a=await fetchJSON(navitiaSA(t));return localStorage.setItem(storeKey(t),JSON.stringify(a)),e(a)}catch(a){const r=localStorage.getItem(storeKey(t));if(r)return e(JSON.parse(r));throw a}function e(t){return t.departures.map(t=>{const e=Date.parse(t.stop_date_time.departure_date_time.substr(0,15));return{waitSec:Math.max(0,Math.round((e-Date.now())/1e3)),dest:stopsGtfs[t.display_informations.direction]??t.display_informations.direction,line:t.display_informations.label}})}}async function fetchTraffic(){return(await Promise.all([LINES.rerA,LINES.bus77,LINES.bus201].map(t=>fetchJSON(navitiaTraffic(t)).catch(()=>null)))).filter(Boolean).flatMap(t=>t.pt_statuses||[]).filter(t=>"NO_EFFECT"!==t.severity?.effect).map(t=>t.message.text)}function render(t,e){document.querySelector(`[data-stop='${t}'] .passages`).innerHTML=e.map(t=>`<div class=row><span class="dest"><span class=icon>${ICONS[t.line]||""}</span>${t.dest}</span><span class=wait data-sec="${t.waitSec}">${formatMin(t.waitSec)}</span></div>`).join("")}function formatMin(t){return t<60?`${Math.floor(t/60)} min`:">1 h"}function tickCountdown(){document.querySelectorAll(".wait[data-sec]").forEach(t=>{let e=parseInt(t.dataset.sec)-1;t.dataset.sec=e,t.textContent=e<=0?"À quai":formatMin(e)})}function showAlerts(t){const e=document.getElementById("alerts");t.length?(e.innerHTML=t.map(t=>`<p>${t}</p>`).join(""),e.classList.add("show")):e.classList.remove("show")}async function refresh(){try{for(const t in STOPS)render(t,await fetchStop(STOPS[t]));showAlerts(await fetchTraffic()),currentInterval=15e3}catch(t){console.error(t),currentInterval=Math.min(2*currentInterval,12e4)}finally{setTimeout(refresh,currentInterval)}}fetch("./static/horaires_export.json").then(t=>t.json()).then(t=>{stopsGtfs=t,setInterval(tickCountdown,1e3),refresh()}).catch(t=>console.error("JSON load error",t));
